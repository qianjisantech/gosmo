package agent

import (
	"agent/internal/svc"
	"agent/internal/types"
	"context"
	"github.com/zeromicro/go-zero/core/logx"
)

type AgentRunLogic struct {
	logx.Logger
	ctx    context.Context
	svcCtx *svc.ServiceContext
}

func NewAgentRunLogic(ctx context.Context, svcCtx *svc.ServiceContext) *AgentRunLogic {
	return &AgentRunLogic{
		Logger: logx.WithContext(ctx),
		ctx:    ctx,
		svcCtx: svcCtx,
	}
}

func (l *AgentRunLogic) AgentRun(req *types.AgentRunRequest) (*types.AgentRunResp, error) {
	//gorPath, err := env.GetGorPath()
	//if err != nil {
	//	return nil, errorx.NewDefaultError("è·å–Gorè·¯å¾„å¤±è´¥: " + err.Error())
	//}
	//
	//cmd := exec.Command(gorPath,
	//	"--input-raw", ":8888",
	//	"--input-raw-track-response",
	//	"--output-http-track-response",
	//	"--output-stdout",
	//	"--prettify-http") // æ·»åŠ ç¾åŒ–é€‰é¡¹ï¼Œä¾¿äºè§£æ
	//
	//stdout, err := cmd.StdoutPipe()
	//if err != nil {
	//	return nil, errorx.NewDefaultError("åˆ›å»ºstdoutç®¡é“å¤±è´¥: " + err.Error())
	//}
	//
	//if err := cmd.Start(); err != nil {
	//	return nil, errorx.NewDefaultError("å¯åŠ¨GoReplayå¤±è´¥: " + err.Error())
	//}
	//
	//go func() {
	//	defer func() {
	//		if cmd.Process != nil {
	//			_ = cmd.Process.Kill()
	//		}
	//	}()
	//	l.HandleTraffic(stdout) // å¤„ç†å®æ—¶æµé‡
	//}()

	return &types.AgentRunResp{
		Success: true,
		Message: "GoReplayå·²å¯åŠ¨ï¼Œæ­£åœ¨å¼‚æ­¥å¤„ç†æµé‡",
	}, nil
}

//// HTTPäº‹åŠ¡ç»“æ„ä½“
//type HTTPTransaction struct {
//	Request  *HTTPRequest  `json:"request,omitempty"`
//	Response *HTTPResponse `json:"response,omitempty"`
//}
//
//type HTTPRequest struct {
//	Method  string            `json:"method"`
//	URL     string            `json:"url"`
//	Headers map[string]string `json:"headers"`
//	Body    string            `json:"body,omitempty"`
//}
//
//type HTTPResponse struct {
//	Status  string            `json:"status"`
//	Headers map[string]string `json:"headers"`
//	Body    string            `json:"body,omitempty"`
//}
//
//func (l *AgentRunLogic) HandleTraffic(reader io.Reader) {
//	scanner := bufio.NewScanner(reader)
//	var currentTx *HTTPTransaction
//	var isBody bool // æ ‡è®°æ˜¯å¦å¼€å§‹å¤„ç†æ­£æ–‡
//
//	for scanner.Scan() {
//		line := scanner.Text()
//
//		// 1. è·³è¿‡åˆ†éš”ç¬¦å’Œç©ºè¡Œ
//		if line == "ğŸµğŸ™ˆğŸ™‰" {
//			if currentTx != nil && currentTx.Request != nil && currentTx.Response != nil {
//				l.ProcessCompleteTransaction(currentTx)
//				currentTx = nil
//				isBody = false
//			}
//			continue
//		}
//
//		// 2. æ£€æµ‹è¯·æ±‚è¡Œ
//		if strings.HasPrefix(line, "POST ") || strings.HasPrefix(line, "GET ") ||
//			strings.HasPrefix(line, "PUT ") || strings.HasPrefix(line, "DELETE ") {
//
//			if currentTx == nil {
//				currentTx = &HTTPTransaction{}
//			}
//			currentTx.Request = l.ParseRequestLine(line)
//			isBody = false // æ–°è¯·æ±‚å¼€å§‹ï¼Œé‡ç½®æ­£æ–‡æ ‡è®°
//			continue
//		}
//
//		// 3. æ£€æµ‹å“åº”è¡Œ
//		if strings.HasPrefix(line, "HTTP/1.1 ") {
//			if currentTx == nil {
//				currentTx = &HTTPTransaction{}
//			}
//			currentTx.Response = l.ParseResponseLine(line)
//			isBody = false // æ–°å“åº”å¼€å§‹ï¼Œé‡ç½®æ­£æ–‡æ ‡è®°
//			continue
//		}
//
//		// 4. å¤„ç†å¤´éƒ¨å’Œæ­£æ–‡
//		if currentTx != nil {
//			// ç©ºè¡Œè¡¨ç¤ºå¤´éƒ¨ç»“æŸï¼Œæ­£æ–‡å¼€å§‹
//			if strings.TrimSpace(line) == "" {
//				isBody = true
//				continue
//			}
//
//			if !isBody {
//				// å¤´éƒ¨å¤„ç†
//				if idx := strings.Index(line, ":"); idx > 0 {
//					key := strings.TrimSpace(line[:idx])
//					value := strings.TrimSpace(line[idx+1:])
//
//					if currentTx.Response == nil && currentTx.Request != nil {
//						if currentTx.Request.Headers == nil {
//							currentTx.Request.Headers = make(map[string]string)
//						}
//						currentTx.Request.Headers[key] = value
//					} else if currentTx.Response != nil {
//						if currentTx.Response.Headers == nil {
//							currentTx.Response.Headers = make(map[string]string)
//						}
//						currentTx.Response.Headers[key] = value
//					}
//				}
//			} else {
//				// æ­£æ–‡å¤„ç†
//				if currentTx.Response == nil && currentTx.Request != nil {
//					currentTx.Request.Body += line + "\n"
//				} else if currentTx.Response != nil {
//					currentTx.Response.Body += line + "\n"
//				}
//			}
//		}
//	}
//
//	// å¤„ç†æœ€åæœªå®Œæˆçš„äº‹åŠ¡
//	if currentTx != nil && currentTx.Request != nil {
//		l.ProcessCompleteTransaction(currentTx)
//	}
//}
//
//func (l *AgentRunLogic) ParseRequestLine(line string) *HTTPRequest {
//	parts := strings.SplitN(line, " ", 3)
//	if len(parts) < 3 {
//		return nil
//	}
//	return &HTTPRequest{
//		Method: parts[0],
//		URL:    parts[1],
//	}
//}
//
//func (l *AgentRunLogic) ParseResponseLine(line string) *HTTPResponse {
//	parts := strings.SplitN(line, " ", 3)
//	if len(parts) < 3 {
//		return nil
//	}
//	return &HTTPResponse{
//		Status: parts[1] + " " + parts[2],
//	}
//}
//
//func (l *AgentRunLogic) ProcessCompleteTransaction(tx *HTTPTransaction) {
//	// 1. è®°å½•åŸå§‹æ•°æ®ï¼ˆè°ƒè¯•ç”¨ï¼‰
//	jsonData, err := json.Marshal(tx)
//	if err != nil {
//		l.Errorf("JSONåºåˆ—åŒ–å¤±è´¥: %v", err)
//		return
//	}
//	l.Debugf("æ•è·åˆ°çš„æµé‡: %s", string(jsonData))
//
//	// 2. å‘é€åˆ°Elasticsearch
//	if err := l.SendDataToElasticsearch(tx); err != nil {
//		l.Errorf("å‘é€åˆ°ESå¤±è´¥: %v", err)
//		// å¯ä»¥æ·»åŠ é‡è¯•é€»è¾‘æˆ–æ­»ä¿¡é˜Ÿåˆ—å¤„ç†
//		return
//	}
//
//	l.Infof("æˆåŠŸè®°å½•äº‹åŠ¡: %s %s â†’ %s",
//		tx.Request.Method,
//		tx.Request.URL,
//		tx.Response.Status)
//}
//func (l *AgentRunLogic) SendDataToElasticsearch(tx *HTTPTransaction) error {
//	if l.svcCtx.ESClient == nil {
//		return errorx.NewDefaultError("Elasticsearch client not initialized")
//	}
//
//	// 1. å‡†å¤‡è¦ç´¢å¼•çš„æ–‡æ¡£
//	doc := map[string]interface{}{
//		"@timestamp": time.Now().Format(time.RFC3339),
//		"request": map[string]interface{}{
//			"method":  tx.Request.Method,
//			"url":     tx.Request.URL,
//			"headers": tx.Request.Headers,
//			"body":    tx.Request.Body,
//		},
//		"response": map[string]interface{}{
//			"status":  tx.Response.Status,
//			"headers": tx.Response.Headers,
//			"body":    tx.Response.Body,
//		},
//	}
//
//	// 2. åºåˆ—åŒ–ä¸ºJSON
//	data, err := json.Marshal(doc)
//	if err != nil {
//		return fmt.Errorf("JSONåºåˆ—åŒ–å¤±è´¥: %w", err)
//	}
//
//	// 3. æ„å»ºESè¯·æ±‚
//	req := esapi.IndexRequest{
//		Index:      l.svcCtx.Config.ElasticSearch.Index, // ç´¢å¼•åç§°
//		DocumentID: "",                                  // ç©ºIDè®©ESè‡ªåŠ¨ç”Ÿæˆ
//		Body:       bytes.NewReader(data),
//		Refresh:    "false", // ç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­ç«‹å³åˆ·æ–°
//	}
//
//	// 4. æ‰§è¡Œè¯·æ±‚
//	res, err := req.Do(context.Background(), l.svcCtx.ESClient)
//	if err != nil {
//		return fmt.Errorf("ESè¯·æ±‚å¤±è´¥: %w", err)
//	}
//	defer res.Body.Close()
//
//	if res.IsError() {
//		return fmt.Errorf("ESé”™è¯¯å“åº”: %s", res.String())
//	}
//
//	return nil
//}
package svc

import (
	"agent/internal/config"
)

type ServiceContext struct {
	Config config.Config
	//ESClient *elasticsearch.Client
}

func NewServiceContext(c config.Config) *ServiceContext {
	//esClient, err := elasticsearch.NewClient(elasticsearch.Config{
	//	Addresses: []string{c.ElasticSearch.Hosts},
	//	//Username:  c.Elasticsearch.Username,
	//	//Password:  c.Elasticsearch.Password,
	//})
	//if err != nil {
	//	logx.Must(err)
	//}
	return &ServiceContext{
		Config: c,
		//ESClient: esClient,
	}
}
Name: agent-api
Host: 0.0.0.0
Port: 8000
Timeout: 10000

ElasticSearch:
   Hosts: "http://47.94.96.190:9200"
   Username: ""
   Password: ""
   Index: "gosmo"  # é»˜è®¤ç´¢å¼•å